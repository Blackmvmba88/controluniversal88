!(function () {
  const e = ('https:' === location.protocol ? 'wss' : 'ws') + '://' + location.host,
    t = new WebSocket(e);
  t.addEventListener('open', () => console.log('WS connected'));
  const n = new Map();
  function i(e) {
    if (!e) return null;
    if (n.has(e)) return n.get(e);
    const t = document.getElementById(e);
    return n.set(e, t), t;
  }
  t.addEventListener('message', (e) => {
    try {
      const t = JSON.parse(e.data);
      if (!t || 'string' != typeof t.type) return;
      if ('button' === t.type) {
        if ('string' != typeof t.id) return;
        const e = i(t.id);
        if (!e) return;
        1 === t.value ? e.classList.add('active') : e.classList.remove('active');
      } else if ('axis' === t.type) {
        const e = i('axis-display');
        if (e) {
          const n = e.innerText,
            i = Object.keys(t)
              .filter((e) => 'type' !== e)
              .map((e) => `${e}: ${t[e]}`)
              .join('  ');
          n !== i && (e.innerText = i);
        }
      } else if ('collect_status' === t.type) {
        const e = i('cal-sensors'),
          n = i('cal-log');
        try {
          if ((e && (e.innerText = t.job.status + ' (' + (t.job.label || '') + ')'), n)) {
            const e = (t.job.progress || [])
              .slice(-5)
              .map((e) => JSON.stringify(e))
              .join('\n');
            n.innerText = e;
          }
        } catch (e) {}
      }
    } catch (e) {
      console.error('WS parse', e);
    }
  }),
    t.addEventListener('close', () => console.log('WS closed'));
  const o = (e) => `Guided â€” ${e}`,
    a = (e) => `Press the '${e}' control now. Waiting for sampling...`,
    c = 'Waiting for data...';
  function r(e) {
    return document.getElementById(e);
  }
  const s = r('cal-start'),
    l = r('cal-auto'),
    d = r('cal-label'),
    u = r('cal-count');
  s &&
    s.addEventListener('click', async () => {
      const e = d.value.trim(),
        t = Number(u.value) || 3,
        n = document.getElementById('cal-log');
      if (e)
        try {
          const i = await fetch('/api/collect/start', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ label: e, count: t }),
            }),
            o = await i.json();
          n.innerText = 'Started job: ' + JSON.stringify(o.job || o);
        } catch (e) {
          alert('Failed to start');
        }
      else alert('Label required');
    }),
    l &&
      l.addEventListener('click', async () => {
        const e = Number(u.value) || 2,
          t = document.getElementById('cal-log');
        try {
          const n = await fetch('/api/collect/auto', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ count: e, save: !1 }),
          });
          await n.json();
          t.innerText = 'Started auto job (preview mode)';
        } catch (e) {
          alert('Failed to start auto');
        }
      });
  const m = r('cal-guided'),
    f = document.getElementById('cal-modal'),
    p = document.getElementById('modal-title'),
    y = document.getElementById('modal-instr'),
    g = document.getElementById('modal-preview'),
    v = document.getElementById('modal-accept'),
    h = document.getElementById('modal-retry'),
    E = document.getElementById('modal-skip'),
    b = document.getElementById('modal-close'),
    k = [
      'square',
      'cross',
      'circle',
      'triangle',
      'l1',
      'r1',
      'l2_btn',
      'r2_btn',
      'share',
      'options',
      'lstick',
      'rstick',
      'ps',
      'dpad_up',
      'dpad_right',
      'dpad_down',
      'dpad_left',
    ];
  let w = null;
  async function T(e) {
    function t(e) {
      if (
        ('Escape' === e.key && (e.preventDefault(), n('close')),
        'Enter' === e.key && (e.preventDefault(), n('accept')),
        'Tab' === e.key)
      ) {
        const t = [v, h, E, b],
          n = t.indexOf(document.activeElement);
        let i = 0;
        (i = e.shiftKey ? (n <= 0 ? t.length - 1 : n - 1) : (n + 1) % t.length),
          t[i].focus(),
          e.preventDefault();
      }
    }
    function n(e) {
      document.removeEventListener('keydown', t),
        v.removeEventListener('click', onAccept),
        h.removeEventListener('click', onRetry),
        E.removeEventListener('click', onSkip),
        b.removeEventListener('click', onClose),
        (f.style.display = 'none'),
        f.setAttribute('aria-hidden', 'true');
      try {
        w && w.focus();
      } catch (e) {}
      resolve(e);
    }
    return (
      (f.style.display = 'flex'),
      f.setAttribute('aria-hidden', 'false'),
      (p.innerText = o(e)),
      (y.innerText = a(e)),
      (g.innerText = c),
      [v, h, E, b].forEach((e) => {
        e.style.display = '';
      }),
      (w = document.activeElement),
      setTimeout(() => {
        try {
          v.focus();
        } catch (e) {}
      }, 10),
      new Promise((e) => {
        v.addEventListener('click', function () {
          n('accept');
        }),
          h.addEventListener('click', function () {
            n('retry');
          }),
          E.addEventListener('click', function () {
            n('skip');
          }),
          b.addEventListener('click', function () {
            n('close');
          }),
          document.addEventListener('keydown', t);
      })
    );
  }
  m &&
    m.addEventListener('click', async () => {
      const e = d.value.trim(),
        t = e
          ? e
              .split(',')
              .map((e) => e.trim())
              .filter(Boolean)
          : k,
        n = Number(u.value) || 2,
        i = document.getElementById('cal-log');
      for (const e of t)
        for (i.innerText = `Starting guided for ${e}...`; ; )
          try {
            const t = await fetch('/api/collect/start', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ label: e, count: n, save: !1 }),
            });
            await t.json();
            let o;
            i.innerText = `Job started for ${e}`;
            for (let e = 0; e < 60; e++) {
              await new Promise((e) => setTimeout(e, 300));
              const e = await (await fetch('/api/collect/status')).json();
              if (e && 'running' !== e.status) {
                o = e;
                break;
              }
            }
            if (!o) {
              if (
                ((i.innerText = `Timeout waiting for ${e}`), confirm(`Timeout for ${e}. Continue?`))
              )
                break;
              throw new Error('user aborted');
            }
            g.innerText = JSON.stringify(o.result || {}, null, 2);
            const a = await T(e);
            if ('accept' === a)
              try {
                await fetch('/api/save-map', {
                  method: 'POST',
                  headers: { 'content-type': 'application/json' },
                  body: JSON.stringify(o.result),
                }),
                  (i.innerText = `Saved mapping for ${e}`);
                break;
              } catch (e) {
                if (((i.innerText = `Failed to save mapping: ${e}`), !confirm('Retry save?')))
                  break;
              }
            else {
              if ('retry' === a) {
                i.innerText = `Retrying ${e}...`;
                continue;
              }
              if ('skip' === a || 'close' === a) {
                i.innerText = `Skipping ${e}`;
                break;
              }
            }
          } catch (t) {
            if (((i.innerText = `Error collecting ${e}: ${t}`), confirm('Continue with next?')))
              break;
            break;
          }
      alert('Guided collection finished');
    });
})();
